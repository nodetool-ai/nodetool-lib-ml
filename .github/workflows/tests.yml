name: Python Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download packaged Conda environment
        run: |
          set -e
          URL="https://github.com/nodetool-ai/nodetool/releases/download/v0.6.0/conda-env-linux-x64.tar.gz"
          echo "Downloading Conda env from ${URL}"
          curl -L -o conda_env.tgz "$URL"
          mkdir -p conda_env
          tar -xzf conda_env.tgz -C conda_env
          chmod +x conda_env/bin/conda-unpack
          ./conda_env/bin/conda-unpack
          rm conda_env/bin/git
          echo "CONDA_ENV_BIN=$(pwd)/conda_env/bin" >> $GITHUB_ENV

      - name: Add Conda env to PATH
        run: echo "$CONDA_ENV_BIN" >> $GITHUB_PATH

      - name: Install project and dev requirements
        run: uv pip install -e . --system
          if [ -f requirements-dev.txt ]; then uv pip install -r requirements-dev.txt --system; fi

      - name: Run tests
        run: pytest
